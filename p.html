<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Chat (P2P)</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #chat-box { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        #message-input { width: 70%; padding: 8px; }
        button { padding: 8px 15px; }
        #peer-id-input { width: 60%; padding: 8px; margin-right: 5px; }
        #user-list { margin-top: 10px; padding: 10px; border: 1px dashed #ccc; }
    </style>
</head>
<body>
    <h1>Student P2P Chat</h1>
    
    <!-- Username Input -->
    <div id="login-section">
        <input type="text" id="username" placeholder="Enter your name">
        <button id="login-btn">Join Chat</button>
    </div>

    <!-- Chat UI (Hidden Until Login) -->
    <div id="chat-section" style="display: none;">
        <div id="chat-box"></div>
        <input type="text" id="message-input" placeholder="Type a message">
        <button id="send-btn">Send</button>
        
        <h3>Connect to Peers:</h3>
        <input type="text" id="peer-id-input" placeholder="Enter Peer ID">
        <button id="connect-btn">Connect</button>
        
        <div id="user-list">
            <strong>Connected Users:</strong>
            <ul id="users"></ul>
        </div>
    </div>

    <!-- PeerJS Library -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <!-- Main Script -->
    <script>
        let peer;
        let currentUsername;
        let activeConnections = {}; // Stores all active peer connections

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const chatSection = document.getElementById('chat-section');
        const usernameInput = document.getElementById('username');
        const loginBtn = document.getElementById('login-btn');
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const peerIdInput = document.getElementById('peer-id-input');
        const connectBtn = document.getElementById('connect-btn');
        const usersList = document.getElementById('users');

        // Initialize PeerJS when user logs in
        loginBtn.addEventListener('click', () => {
            currentUsername = usernameInput.value.trim();
            if (!currentUsername) return alert("Please enter a username!");

            // Create a Peer with a random ID (username + random number)
            peer = new Peer(currentUsername + "-" + Math.floor(Math.random() * 1000));

            peer.on('open', (id) => {
                console.log("My Peer ID:", id);
                loginSection.style.display = 'none';
                chatSection.style.display = 'block';
                addMessage("System", `You joined with ID: ${id}`);
            });

            // Handle incoming connections
            peer.on('connection', (conn) => {
                setupConnection(conn);
            });

            peer.on('error', (err) => {
                console.error("PeerJS Error:", err);
            });
        });

        // Connect to another peer manually
        connectBtn.addEventListener('click', () => {
            const peerId = peerIdInput.value.trim();
            if (!peerId) return alert("Enter a Peer ID!");
            
            const conn = peer.connect(peerId);
            setupConnection(conn);
        });

        // Send message to all connected peers
        sendBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(currentUsername, message);
            messageInput.value = '';

            // Broadcast to all connected peers
            Object.values(activeConnections).forEach(conn => {
                conn.send({
                    type: 'message',
                    user: currentUsername,
                    text: message
                });
            });
        });

        // Set up a new connection (incoming or outgoing)
        function setupConnection(conn) {
            conn.on('open', () => {
                activeConnections[conn.peer] = conn;
                updateUserList();
                
                // Send initial user data
                conn.send({
                    type: 'user-join',
                    user: currentUsername
                });
            });

            conn.on('data', (data) => {
                if (data.type === 'message') {
                    addMessage(data.user, data.text);
                } else if (data.type === 'user-join') {
                    addMessage("System", `${data.user} joined the chat`);
                    updateUserList();
                }
            });

            conn.on('close', () => {
                delete activeConnections[conn.peer];
                updateUserList();
            });
        }

        // Update the list of connected users
        function updateUserList() {
            usersList.innerHTML = '';
            Object.keys(activeConnections).forEach(peerId => {
                const li = document.createElement('li');
                li.textContent = peerId.split('-')[0]; // Show username only
                usersList.appendChild(li);
            });
        }

        // Add a message to the chat box
        function addMessage(user, text) {
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `<strong>${user}:</strong> ${text}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>
